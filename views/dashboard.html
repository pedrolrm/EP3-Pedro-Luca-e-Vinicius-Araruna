<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - FincApp</title>
    <link rel="stylesheet" href="/static/css/style.css?v=3" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="dashboard-body">
    <nav class="navbar">
      <a href="/" class="logo" style="text-decoration:none; color: white;">FincApp</a>
      <div class="nav-links">
        <a
          href="/recorrencias"
          class="nav-item"
          style="color: white; margin-right: 20px"
          >Minhas Recorr√™ncias</a
        >
        <span style="color: rgba(255, 255, 255, 0.7); margin-right: 15px"
          >|</span
        >
        <span style="color: white; margin-right: 20px; opacity: 0.9"
          >Ol√°, {{user_name}}</span
        >

        <button id="btn-nova-transacao" class="btn-nav btn-nav-primary">
          Nova Transa√ß√£o
        </button>
        <button
          id="btn-ver-transacoes"
          class="btn-nav btn-nav-secondary"
          style="margin-left: 10px"
        >
          Ver Transa√ß√µes
        </button>

        <a href="/logout" class="btn-logout" style="margin-left: 15px">Sair</a>
      </div>
    </nav>

    <div
      class="container-msg"
      style="max-width: 1200px; margin: 20px auto; padding: 0 20px"
    >
      % if defined('msg') and msg:
      <div
        style="
          background-color: #d1e7dd;
          color: #0f5132;
          padding: 15px;
          border-radius: 8px;
          border: 1px solid #badbcc;
          display: flex;
          align-items: center;
          gap: 10px;
        "
      >
        <span>*</span>
        <strong>{{msg}}</strong>
      </div>
      % end
    </div>

    <div class="main-container">
      <div class="summary-grid">
        <div class="card summary-card">
          <div class="card-icon icon-receita">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 19V5m-7 7l7-7 7 7"
              />
            </svg>
          </div>
          <div>
            <h3>Receita Total</h3>
            <p class="valor receita" id="total-receitas">...</p>
          </div>
        </div>

        <div class="card summary-card">
          <div class="card-icon icon-despesa">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 5v14m7-7l-7 7-7-7"
              />
            </svg>
          </div>
          <div>
            <h3>Despesa Total</h3>
            <p class="valor despesa" id="total-despesas">...</p>
          </div>
        </div>

        <div class="card summary-card">
          <div class="card-icon icon-saldo">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <div>
            <h3>Saldo Atual</h3>
            <p class="valor" id="total-saldo">...</p>
          </div>
        </div>
      </div>

      <div class="full-width-chart-section">
        <div class="card chart-card" style="min-height: 350px">
          <div class="card-header">
            <h3>Evolu√ß√£o do Saldo (√öltimos 6 meses)</h3>
          </div>
          <div class="chart-container-box">
            <canvas id="graficoLinhaSaldo"></canvas>
          </div>
        </div>
      </div>

      <div class="charts-grid-split">
        <div class="card chart-card">
          <div class="card-header">
            <h3>Comparativo: Receitas vs Despesas</h3>
          </div>
          <div class="chart-container-box">
            <canvas id="graficoBarrasComparativo"></canvas>
          </div>
        </div>

        <div class="card chart-card">
          <div class="card-header">
            <h3>Gastos por Categoria</h3>
          </div>
          <div class="chart-container-box doughnut-container">
            <canvas id="graficoCategoria"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-transacao" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Nova Transa√ß√£o</h3>
          <button class="close-btn" id="fechar-modal">&times;</button>
        </div>

        <form id="form-transacao" class="modal-form">
          <div class="form-group">
            <label>Descri√ß√£o</label>
            <input
              type="text"
              name="descricao"
              placeholder="Ex: Compras do m√™s"
              required
            />
          </div>

          <div
            class="form-group"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
          >
            <div>
              <label>Valor (R$)</label>
              <input
                type="number"
                name="valor"
                step="0.01"
                placeholder="0.00"
                required
              />
            </div>
            <div>
              <label>Data</label>
              <input type="date" name="data" required />
            </div>
          </div>

          <div class="form-group">
            <label>Categoria</label>
            <select name="categoria_id" id="select-categoria" required>
              <option value="">Carregando categorias...</option>
            </select>
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn full-width-btn"
              style="background-color: #9ca3af"
              id="cancelar-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn full-width-btn">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modal-view-transacoes" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Minhas Transa√ß√µes</h3>
          <button class="close-btn" id="fechar-modal-view">&times;</button>
        </div>

        <div class="modal-body" style="max-height: 60vh; overflow-y: auto">
          <div id="lista-transacoes">
            <p style="text-align: center; padding: 20px; color: #6b7280">
              Carregando...
            </p>
          </div>
        </div>

        <div
          class="modal-footer"
          style="
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #e5e7eb;
            background: white;
            border-radius: 0 0 10px 10px;
          "
        >
          <button
            class="btn"
            id="fechar-modal-view-bottom"
            style="background: #6b7280; color: white"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Formata√ß√µes
      const formatMoney = (value) =>
        new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(value);
      const cleanScales = {
        y: { beginAtZero: true, grid: { color: "#f3f4f6", drawBorder: false } },
        x: { grid: { display: false } },
      };

      // Vari√°veis Globais de Gr√°ficos (para poder destruir e recriar)
      let chartLinha = null;
      let chartBarra = null;
      let chartPizza = null;

      // --- FUN√á√ÉO PRINCIPAL: CARREGAR DASHBOARD ---
      async function carregarDashboard() {
        try {
          const response = await fetch("/estatisticas/dashboard");
          if (!response.ok) throw new Error("Erro na API");
          const dados = await response.json();

          // Preencher Cards
          document.getElementById("total-receitas").innerText = formatMoney(
            dados.resumo.receitas
          );
          document.getElementById("total-despesas").innerText = formatMoney(
            dados.resumo.despesas
          );
          const saldoEl = document.getElementById("total-saldo");
          saldoEl.innerText = formatMoney(dados.resumo.saldo);
          saldoEl.style.color = dados.resumo.saldo >= 0 ? "#10b981" : "#ef4444";

          // Destruir gr√°ficos antigos se existirem (para atualizar anima√ß√£o)
          if (chartLinha) chartLinha.destroy();
          if (chartBarra) chartBarra.destroy();
          if (chartPizza) chartPizza.destroy();

          // 1. Gr√°fico Linha
          chartLinha = new Chart(document.getElementById("graficoLinhaSaldo"), {
            type: "line",
            data: {
              labels: dados.grafico_evolucao.map((d) => d.mes),
              datasets: [
                {
                  label: "Saldo",
                  data: dados.grafico_evolucao.map((d) => d.saldo),
                  borderColor: "#3b82f6",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  tension: 0.4,
                  fill: true,
                  pointRadius: 5,
                  borderWidth: 3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: cleanScales,
              plugins: { legend: { display: false } },
            },
          });

          // 2. Gr√°fico Barras
          chartBarra = new Chart(
            document.getElementById("graficoBarrasComparativo"),
            {
              type: "bar",
              data: {
                labels: dados.grafico_evolucao.map((d) => d.mes),
                datasets: [
                  {
                    label: "Receitas",
                    data: dados.grafico_evolucao.map((d) => d.receitas),
                    backgroundColor: "#10b981",
                    borderRadius: 4,
                  },
                  {
                    label: "Despesas",
                    data: dados.grafico_evolucao.map((d) => d.despesas),
                    backgroundColor: "#ef4444",
                    borderRadius: 4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: cleanScales,
              },
            }
          );

          // 3. Gr√°fico Pizza
          chartPizza = new Chart(document.getElementById("graficoCategoria"), {
            type: "doughnut",
            data: {
              labels: dados.grafico_pizza.map((d) => d.categoria),
              datasets: [
                {
                  data: dados.grafico_pizza.map((d) => d.total),
                  backgroundColor: [
                    "#3b82f6",
                    "#ef4444",
                    "#f59e0b",
                    "#10b981",
                    "#8b5cf6",
                    "#6366f1",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "75%",
              plugins: {
                legend: {
                  position: "right",
                  labels: { usePointStyle: true, boxWidth: 8 },
                },
              },
            },
          });
        } catch (error) {
          console.error("Erro dashboard:", error);
        }
      }

      // --- L√ìGICA DO MODAL ---
      const modal = document.getElementById("modal-transacao");
      const btnNova = document.getElementById("btn-nova-transacao");
      const btnFechar = document.getElementById("fechar-modal");
      const btnCancelar = document.getElementById("cancelar-modal");
      const formTransacao = document.getElementById("form-transacao");
      const selectCategoria = document.getElementById("select-categoria");

      // Abrir Modal
      btnNova.addEventListener("click", async () => {
        modal.classList.add("active");
        // Define data de hoje como padr√£o
        document.querySelector('input[name="data"]').valueAsDate = new Date();
        // Carregar Categorias
        await carregarCategorias();
      });

      // Fechar Modal
      const fecharModal = () => modal.classList.remove("active");
      btnFechar.addEventListener("click", fecharModal);
      btnCancelar.addEventListener("click", fecharModal);

      // Buscar Categorias do Backend
      async function carregarCategorias() {
        try {
          const res = await fetch("/categorias");
          const categorias = await res.json();
          selectCategoria.innerHTML =
            '<option value="" disabled selected>Selecione...</option>';

          categorias.forEach((cat) => {
            // Adiciona emoji baseado no tipo
            const icone = cat.tipo === "receita" ? "üí∞" : "üí∏";
            selectCategoria.innerHTML += `<option value="${cat.id}">${icone} ${cat.nome}</option>`;
          });
        } catch (error) {
          console.error("Erro categorias:", error);
          selectCategoria.innerHTML = "<option>Erro ao carregar</option>";
        }
      }

      // --- SALVAR TRANSA√á√ÉO (AJAX) ---
      formTransacao.addEventListener("submit", async (e) => {
        e.preventDefault(); // Impede recarregar a p√°gina

        // Pega dados do form
        const formData = new FormData(formTransacao);
        const dados = Object.fromEntries(formData.entries());

        // Converte valores num√©ricos
        dados.valor = parseFloat(dados.valor);
        dados.categoria_id = parseInt(dados.categoria_id);

        try {
          const res = await fetch("/transacoes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
          });

          if (res.ok) {
            // Sucesso!
            fecharModal();
            formTransacao.reset();
            // Atualiza o dashboard sem F5
            carregarDashboard();
          } else {
            alert("Erro ao salvar transa√ß√£o.");
          }
        } catch (error) {
          console.error("Erro ao salvar:", error);
        }
      });

      const modalView = document.getElementById("modal-view-transacoes");
      const btnVer = document.getElementById("btn-ver-transacoes");
      const btnFecharView = document.getElementById("fechar-modal-view");
      const btnFecharViewBottom = document.getElementById(
        "fechar-modal-view-bottom"
      );

      btnVer.addEventListener("click", async () => {
        modalView.classList.add("active");
        await carregarListaTransacoes();
      });

      const fecharView = () => modalView.classList.remove("active");
      btnFecharView.addEventListener("click", fecharView);
      btnFecharViewBottom.addEventListener("click", fecharView);

      async function carregarListaTransacoes() {
        const listaTransacoes = document.getElementById("lista-transacoes");
        listaTransacoes.innerHTML =
          '<p style="text-align:center; color:#6b7280; padding:20px;">Carregando transa√ß√µes...</p>';

        try {
          const res = await fetch("/transacoes");
          if (!res.ok) throw new Error("Erro API");
          const dados = await res.json();

          if (!Array.isArray(dados) || dados.length === 0) {
            listaTransacoes.innerHTML = `
                    <div style="text-align:center; padding: 40px 20px;">
                        <p style="font-size: 3rem; margin-bottom: 10px;">üçÉ</p>
                        <p style="color: #6b7280;">Voc√™ ainda n√£o possui transa√ß√µes.</p>
                    </div>`;
            return;
          }

          listaTransacoes.innerHTML = "";

          dados.forEach((t) => {
            const el = document.createElement("div");
            el.className = "transacao-item";

            let dataFormatada = t.data;
            try {
              const [ano, mes, dia] = t.data.split("-");
              dataFormatada = `${dia}/${mes}/${ano}`;
            } catch (e) {}

            el.innerHTML = `
                    <div class="transacao-view">
                        <div class="transacao-header">
                            <span class="transacao-titulo">${
                              t.descricao || "(Sem descri√ß√£o)"
                            }</span>
                            <span class="transacao-valor">${formatMoney(
                              t.valor
                            )}</span>
                        </div>
                        
                        <div class="transacao-sub">
                            <span>üìÖ ${dataFormatada}</span>
                            <span>‚Ä¢</span>
                            <span>üè∑Ô∏è ${t.categoria_nome || "Geral"}</span>
                        </div>

                        <div class="transacao-actions">
                            <button class="btn-sm btn-editar" data-id="${
                              t.id
                            }">‚úèÔ∏è Editar</button>
                            <button class="btn-sm btn-deletar" data-id="${
                              t.id
                            }">üóëÔ∏è Excluir</button>
                        </div>
                    </div>

                    <div class="edit-area" id="edit-area-${
                      t.id
                    }" style="display:none;">
                        <form data-id="${t.id}" class="form-edit-transacao">
                            <label>Descri√ß√£o</label>
                            <input name="descricao" type="text" value="${
                              t.descricao || ""
                            }" required />
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                <label>Valor</label>
                                <input name="valor" type="number" step="0.01" value="${
                                  t.valor
                                }" required />
                                </div>
                                <div>
                                <label>Data</label>
                                <input name="data" type="date" value="${
                                  t.data
                                }" required />
                                </div>
                            </div>

                            <label>Categoria</label>
                            <select name="categoria_id" required>
                                <option value="">Carregando...</option>
                            </select>

                            <div class="edit-actions">
                                <button type="button" class="btn-sm" style="background:#e5e7eb; color:#374151;" 
                                    onclick="document.getElementById('edit-area-${
                                      t.id
                                    }').style.display='none'">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-sm" style="background:#3b82f6; color:white;">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                    `;
            listaTransacoes.appendChild(el);
          });

          await carregarCategoriasParaEdicao();

          document.querySelectorAll(".btn-editar").forEach((b) =>
            b.addEventListener("click", (e) => {
              const id = e.currentTarget.dataset.id;
              document
                .querySelectorAll(".edit-area")
                .forEach((el) => (el.style.display = "none"));
              document.getElementById("edit-area-" + id).style.display =
                "block";
            })
          );

          document.querySelectorAll(".btn-deletar").forEach((b) =>
            b.addEventListener("click", async (e) => {
              const id = e.currentTarget.dataset.id;
              if (!confirm("Tem certeza que deseja excluir esta transa√ß√£o?"))
                return;
              try {
                const res = await fetch(`/transacoes/${id}`, {
                  method: "DELETE",
                });
                if (res.ok) {
                  await carregarListaTransacoes();
                  carregarDashboard();
                } else {
                  alert("Erro ao excluir.");
                }
              } catch (err) {
                console.error(err);
              }
            })
          );

          document.querySelectorAll(".form-edit-transacao").forEach((form) => {
            form.addEventListener("submit", async (ev) => {
              ev.preventDefault();
              const id = form.dataset.id;
              const fd = new FormData(form);
              const body = Object.fromEntries(fd.entries());
              body.valor = parseFloat(body.valor);
              body.categoria_id = parseInt(body.categoria_id);

              try {
                const res = await fetch(`/transacoes/${id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(body),
                });
                if (res.ok) {
                  await carregarListaTransacoes();
                  carregarDashboard();
                } else {
                  alert("Erro ao atualizar.");
                }
              } catch (err) {
                console.error(err);
              }
            });
          });
        } catch (error) {
          console.error("Erro lista:", error);
          listaTransacoes.innerHTML =
            '<p style="color:red; text-align:center;">Erro ao carregar dados.</p>';
        }
      }

      async function carregarCategoriasParaEdicao() {
        try {
          const res = await fetch("/categorias");
          const categorias = await res.json();
          document
            .querySelectorAll(
              '.form-edit-transacao select[name="categoria_id"]'
            )
            .forEach((sel) => {
              sel.innerHTML = '<option value="" disabled>Selecione...</option>';
              categorias.forEach((c) => {
                sel.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
              });
            });
        } catch (err) {
          console.error("Erro cat edicao:", err);
        }
      }

      // Inicializar
      document.addEventListener("DOMContentLoaded", carregarDashboard);
    </script>
  </body>
</html>
